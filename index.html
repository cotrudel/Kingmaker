<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <link rel="stylesheet" type="text/css" href="css/map.css">
    <link rel="stylesheet" type="text/css" href="css/building.css">
    <link rel="stylesheet" type="text/css" href="css/battle.css">
    <link rel="stylesheet" type="text/css" href="css/resources.css">
    <link rel="stylesheet" type="text/css" href="css/misc.css">
    <link rel="stylesheet" type="text/css" href="css/fog.css">
    <link rel="stylesheet" type="text/css" href="scripts/tooltipster/css/tooltipster.bundle.css" />

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.10.0.min.js"></script>
    <script type="text/javascript" src="scripts/tooltipster/js/tooltipster.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs@1.3/dist/interact.min.js"></script>
</head>

<body>
    <div class="wrapper" > 
            <!-- oncontextmenu="javascript:alert('success!');return false;"" -->
        <div class="displayer">
            <div align="center" class="file gimmeSpace" >
                <label for="openData">
                    <img src="img/load.png" title="Load existing map"/>
                </label>
            
                <input id="openData" type="file"/>
            </div>

            <hr>

            <div align="center" class="file gimmeSpace">
                <label for="saveData">
                    <img src="img/save.png" title="Save current map"/>
                </label>
            
                <input id="saveData" onclick="saveFile()" />
            </div>

            <hr>
            <hr>

            <div class="checkboxDisplay">
                <input type="checkbox" id="building" class="checkbox" name="display-building" checked>
                <label for="building" class="label">Buildings</label>
            </div>
            <!-- <div class="checkboxDisplay">
                <input type="checkbox" id="battle" class="checkbox" name="display-battle">
                <label for="battle" class="label">Battles</label>
            </div> -->
            <div class="checkboxDisplay">
                <input type="checkbox" id="resources" class="checkbox" name="display-resources">
                <label for="resources" class="label">Resources</label>
            </div>
            <div class="checkboxDisplay">
                <input type="checkbox" id="misc" class="checkbox" name="display-misc">
                <label for="misc" class="label">Misc</label>
            </div>
            <button onclick="createMapDecoration()">Add map decoration</button>
        </div>

        <img src="img/map.jpg" class="background" />
        <img src="img/token.png" class="player draggable" />

        <div class="mapDecoration">
            <!-- Battle -->
            <!-- <img src="img/battle.png" class="happs battle tooltip" title="Happs" />
            <img src="img/battle.png" class="kressle battle tooltip" title="Kressle" /> -->
        </div>
    </div>
</body>
<script>
    $(document).ready(function () {
        // Checkbox
        createCheckbox("building");
        // createCheckbox("battle");
        createCheckbox("resources");
        createCheckbox("misc");

        // Load data
        loadFile();
        
        // Drag 'n drop 
        drapAndDrop();

        // Right click
        // document.getElementsByClassName('wrapper').addEventListener('contextmenu', function(ev) {
        //     ev.preventDefault();
        //     alert('success!');
        //     return false;
        // }, false);
    });

    function drapAndDrop(){
        interact('.draggable')
            .draggable({
                autoScroll: true,
                // call this function on every dragmove event
                onmove: dragMoveListener
            });
    };

    function dragMoveListener (event) {
        var target = event.target,
            // keep the dragged position in the data-x/data-y attributes
            x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
            y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

        // translate the element
        target.style.webkitTransform =
        target.style.transform =
        'translate(' + x + 'px, ' + y + 'px)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
    }

    function saveFile() {
        var map = convertMapToObject();

        var file = new Blob([map], { type: "text/ plain" });
        if (window.navigator.msSaveOrOpenBlob) // IE10+
            window.navigator.msSaveOrOpenBlob(file, "map.json");
        else { // Others
            var a = document.createElement("a"),
                url = URL.createObjectURL(file);
            a.href = url;
            a.download = "Kingmaker.map";
            document.body.appendChild(a);
            a.click();
            setTimeout(function () {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        }
    };

    function convertMapToObject() {
        var mapContainer = $(".mapDecoration").find("img");

        var building = [];
        var resources = [];
        var misc = [];
        var fog = [];
        for (var i = 0; i < mapContainer.length; i++) {
            var newElement = htmlToObject(mapContainer[i]);
            
            var elementType = getElementType(newElement.class);
            switch (elementType) {
                case "fog": fog.push(newElement);
                    break;
                case "building": building.push(newElement);
                    break;
                case "resources": resources.push(newElement);
                    break;
                case "misc": misc.push(newElement);
                    break;
            }
            var player = createPlayerObject();

            var map = { player, building, resources, misc, fog };
        }

        return JSON.stringify(map);
    };

    function createPlayerObject(){
        var x = $(".player").data("x") ;
        var y = $(".player").data("y") ;

        return {x, y};
    };

    function htmlToObject(element) {
        
        //Firefox doesn't suppport "?<=" regex properly so I use a workaround
        //var myRegexp = /(?<=img\/)(.*)(?=\.png)/g;
        //var img = myRegexp.exec(element.currentSrc)[1];

        var imageName = element.currentSrc.split("img/");
        var img = imageName[1].replace(".png", "")

        var name = element.name;
        var className = element.className.replace("fog", "").replace("tooltipstered", "").replace("tooltip", "").replace(img, "").trim() + " " + img; // remove the plugin class
        var top = element.style.top.replace("px", "").replace('"', "");
        var left = element.style.left.replace("px", "");
        var title = element.alt;

        return { "class": className.trim(), img, name, top, left, title };
    }

    function getElementType(className) {
        return className.includes("building") ? "building" :
                className.includes("resources") ? "resources" :
                    className.includes("misc") ? "misc" : "fog";
    }

    function tooltip() {
        $('.tooltip').tooltipster();
    };

    function loadFile(){
        $("#openData").change(function (e) {
            var file = e.target.files[0];
            if (!file) {
                return;
            }
            var reader = new FileReader();
            reader.onload = function (e) {
                var data = JSON.parse(e.target.result);
                createMapDecoration(data);
            };
            reader.readAsText(file);
        });
    };

    function createMapDecoration(data) {
        cleanMap();

        addPlayerToMap(data.player);
        addElementToMap(data.fog, "fogOfWar", true);
        addElementToMap(data.building, "buildingSection", false);
        addElementToMap(data.resources, "resourcesSection", false);
        addElementToMap(data.misc, "miscSection", false);

        tooltip();
    };

    function cleanMap(){
        $(".fogOfWar").remove();
        $(".buildingSection").remove();
        $(".resourcesSection").remove();
        $(".miscSection").remove();
    };

    function addPlayerToMap(player){
        var x = player && player.x ? player.x : 0;
        var y = player && player.y ? player.y : 0;
        $(".player").data("x", x);
        $(".player").data("y", y);
        $(".player").css({"-webkit-transform":"translate(" + x + "px, " + y + "px)"});
        $(".player").css({"-transform":"translate(" + x + "px, " + y + "px)"});
    };

    function addElementToMap(item, sectionName, isFogOfWar) {
        if (item) {
            $(".mapDecoration").append("<div class='" + sectionName + "'> </div>");
            var div = $("." + sectionName);

            for (var i = 0; i < item.length; i++) {
                var obj = item[i];

                var visited = obj.visited && obj.visited == true ? "visited" : "";
                var name = obj.name ? obj.name : "";
                var cssClass = obj.class ? obj.class : "";
                var title = obj.title ? obj.title.replace("'", "&#39;") : "";
                var elementType = isFogOfWar ? "fog" : "tooltip";

                var img = createImgDiv(obj.img, name, cssClass, visited, elementType, obj.top, obj.left, title);
                div.append(img);
            }
        }
    };

    function createImgDiv(picName, elementName, cssClass, visited, elementType, top, left, title) {
        var fullClass = (cssClass + " " + visited + " " + elementType).trim();
        return "<img src='img/" + picName + ".png' name='" + elementName + "' class='" + fullClass + "' style='top:" + top + "px; left:" + left + "px' title='" + title + "' alt='" + title + "' />";
    };

    function createCheckbox(name) {
        $('input[type="checkbox"][name="display-' + name + '"]').change(function () {
            if (this.checked) {
                $("." + name).show();
            }
            else {
                $("." + name).hide();
            }
        });
    };
</script>

</html>